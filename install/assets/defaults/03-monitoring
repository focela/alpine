#!/command/with-contenv bash
#------------------------------------------------------------------------
# Zabbix Agent Monitoring Configuration
#
# Purpose: Sets default environment variables for Zabbix monitoring agent
# configuration. This script establishes baseline settings for agent
# behavior, logging, networking, and OS-specific agent type selection.
#
# Note: This script uses the ${VAR:-"default"} pattern to set defaults
# only if the variables are not already defined in the environment.
# All values can be overridden at container runtime.
#------------------------------------------------------------------------

#------------------------------------------------------------------------
# LOGGING CONFIGURATION
#------------------------------------------------------------------------
# Log file settings
ZABBIX_AGENT_LOG_FILE=${ZABBIX_AGENT_LOG_FILE:-"zabbix_agentd.log"}
ZABBIX_AGENT_LOG_PATH=${ZABBIX_AGENT_LOG_PATH:-"/var/log/zabbix/agent/"}
ZABBIX_LOG_FILE_SIZE=${ZABBIX_LOG_FILE_SIZE:-"0"}
ZABBIX_DEBUGLEVEL=${ZABBIX_DEBUGLEVEL:-"1"}

#------------------------------------------------------------------------
# NETWORK CONFIGURATION
#------------------------------------------------------------------------
# Network listening settings
ZABBIX_LISTEN_IP=${ZABBIX_LISTEN_IP:-"0.0.0.0"}
ZABBIX_LISTEN_PORT=${ZABBIX_LISTEN_PORT:-"10050"}
ZABBIX_STATUS_PORT=${ZABBIX_STATUS_PORT:-"8050"}

# Server connection settings
ZABBIX_SERVER=${ZABBIX_SERVER:-"0.0.0.0/0"}
ZABBIX_SERVER_ACTIVE=${ZABBIX_SERVER_ACTIVE:-"zabbix-proxy"}

#------------------------------------------------------------------------
# AGENT IDENTITY AND REGISTRATION
#------------------------------------------------------------------------
# Agent identification
ZABBIX_HOSTNAME=${ZABBIX_HOSTNAME:-"${CONTAINER_NAME}"}

# Auto-registration settings
ZABBIX_ENABLE_AUTOREGISTER=${ZABBIX_ENABLE_AUTOREGISTER:-"TRUE"}
ZABBIX_ENABLE_AUTOREGISTER_DNS=${ZABBIX_ENABLE_AUTOREGISTER_DNS:-"TRUE"}
ZABBIX_SETUP_TYPE=${ZABBIX_SETUP_TYPE:-"AUTO"}

#------------------------------------------------------------------------
# PERFORMANCE AND BUFFER CONFIGURATION
#------------------------------------------------------------------------
# Buffer settings for data transmission
ZABBIX_BUFFER_SEND=${ZABBIX_BUFFER_SEND:-"5"}
ZABBIX_BUFFER_SIZE=${ZABBIX_BUFFER_SIZE:-"100"}

# Performance limits
ZABBIX_MAXLINES_SECOND=${ZABBIX_MAXLINES_SECOND:-"20"}
ZABBIX_REFRESH_ACTIVE_CHECKS=${ZABBIX_REFRESH_ACTIVE_CHECKS:-"120"}
ZABBIX_AGENT_TIMEOUT=${ZABBIX_AGENT_TIMEOUT:-"3"}

#------------------------------------------------------------------------
# PROCESS AND USER CONFIGURATION
#------------------------------------------------------------------------
# Process settings
ZABBIX_START_AGENTS=${ZABBIX_START_AGENTS:-"1"}
ZABBIX_ALLOW_ROOT=${ZABBIX_ALLOW_ROOT:-"1"}

# User and privilege settings
ZABBIX_USER=${ZABBIX_USER:-"zabbix"}
ZABBIX_USER_DOAS=${ZABBIX_USER_DOAS:-"TRUE"}
ZABBIX_USER_SUDO=${ZABBIX_USER_SUDO:-"TRUE"}

#------------------------------------------------------------------------
# REMOTE COMMAND CONFIGURATION
#------------------------------------------------------------------------
# Remote command execution settings
ZABBIX_REMOTECOMMANDS_ALLOW=${ZABBIX_REMOTECOMMANDS_ALLOW:-"*"}
ZABBIX_REMOTECOMMANDS_LOG=${ZABBIX_REMOTECOMMANDS_LOG:-"1"}

#------------------------------------------------------------------------
# FILE PATHS AND CERTIFICATES
#------------------------------------------------------------------------
# Configuration file paths
ZABBIX_CONFIG_FILE=${ZABBIX_CONFIG_FILE:-"zabbix_agentd.conf"}
ZABBIX_CONFIG_PATH=${ZABBIX_CONFIG_PATH:-"/etc/zabbix/"}

# Runtime file paths
ZABBIX_PID=${ZABBIX_PID:-"/var/lib/zabbix/run/zabbix-agent.pid"}
ZABBIX_SOCKET=${ZABBIX_SOCKET:-"/var/lib/zabbix/run/zabbix-agent.sock"}

# Certificate path for secure connections
ZABBIX_CERT_PATH=${ZABBIX_CERT_PATH:-"/etc/zabbix/certs/"}

#------------------------------------------------------------------------
# OS DETECTION AND AGENT TYPE SELECTION
#------------------------------------------------------------------------
# Detect operating system from /etc/os-release
os=$(cat /etc/os-release |grep ^ID= | cut -d = -f2)

# Determine appropriate Zabbix agent type based on OS and version
case ${os} in
  "alpine" )
    # Extract Alpine version number (major.minor format)
    osver=$(cat /etc/os-release | grep VERSION_ID | cut -d = -f 2 | cut -d . -f 2 | cut -d _ -f 1)

    # Alpine 3.15+ supports modern agent, older versions need classic
    if [ "${osver}" -ge 15 ] || [ "$osver" = "edge" ] ; then
      ZABBIX_AGENT_TYPE=${ZABBIX_AGENT_TYPE:-"modern"}
    else
      ZABBIX_AGENT_TYPE=${ZABBIX_AGENT_TYPE:-"classic"}
    fi
  ;;
  "debian" | "ubuntu" )
    # Debian and Ubuntu distributions support modern agent
    ZABBIX_AGENT_TYPE=${ZABBIX_AGENT_TYPE:-"modern"}
  ;;
esac
