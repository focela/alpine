#!/command/with-contenv bash
#
# Firewall service script
# Starts the Fail2ban service for blocking malicious hosts
#

#------------------------------------------------------------------------------------------
# INITIAL SETUP
#------------------------------------------------------------------------------------------
# Import container functions and initialize service
source /assets/functions/00-container
output_off
PROCESS_NAME="firewall"
prepare_service defaults single
check_container_initialized
check_service_initialized init

# Mark initialization complete
liftoff

#------------------------------------------------------------------------------------------
# FAIL2BAN STARTUP
#------------------------------------------------------------------------------------------
# Wait for logs to be populated before starting Fail2ban
print_debug "Sleeping for '${FAIL2BAN_STARTUP_DELAY}' seconds before starting Fail2ban to make sure logs are populated"
sleep ${FAIL2BAN_STARTUP_DELAY}

print_start "Starting Fail2ban"

# Start Fail2ban with appropriate output settings based on log type
if [ "${FAIL2BAN_LOG_TYPE,,}" = "file" ]; then
    output_on
    silent exec fail2ban-server -f
else
    output_on
    exec fail2ban-server -f
fi
